/**
 * Smakflakes
 * @author Yury Vasilyev
 * Copyright (c) 2014 by Yury Vasilyev (aka iamMakep)
 */
(function(a){a.fn.smakflakes=function(d){var c={flks_image:null,fi_width:0,fi_height:0,last_flakesfile:"",last_flaketype:"",last_flakecolor:{r:null,g:null,b:null},last_flakeshadow_color:{r:null,g:null,b:null},colors_random:null,rainbowstep:0,rainbowclr:0,issnow:true,w_height:0,w_width:0,canvas:null,context:null,fbody:null,flakes:new Array(),global_fdspeed:1,global_windspeed:0,last_stopfall:false,compareRGBs:function(f,e){if(f.r!=e.r){return false;}if(f.g!=e.g){return false;}if(f.b!=e.b){return false;}return true;},genereateRGBstring:function(e){var f=e.r+", "+e.g+", "+e.b;return f;},inRad:function(e){return e*Math.PI/180;},getRandomArbitary:function(f,e){return Math.random()*(e-f)+f;},getRandomInt:function(f,e){return Math.floor(Math.random()*(e-f+1))+f;}};var b={init:function(e){this.smakflakes.settings=a.extend({},this.smakflakes.defaults,e);return this.each(function(){c.field=a(this);c.w_height=a(window).height();c.w_width=a(window).width();c.last_stopfall=a(this).smakflakes.settings.stopfall;if(typeof(a(this).smakflakes.settings.flakeopacity)=="string"){if(a(this).smakflakes.settings.flakeopacity=="random"){a(this).smakflakes.settings.flakeopacity=0;}}else{if(typeof(a(this).smakflakes.settings.flakeopacity)=="number"){if(a(this).smakflakes.settings.flakeopacity<=0){a(this).smakflakes.settings.flakeopacity=0;}if(a(this).smakflakes.settings.flakeopacity>=1){a(this).smakflakes.settings.flakeopacity=1;}}else{a(this).smakflakes.settings.flakeopacity=0;}}if(a(this).smakflakes.settings.flakescount<=0){a(this).smakflakes.settings.flakescount=1;}c.last_flakesfile=a(this).smakflakes.settings.flakesfile;if(a(this).smakflakes.settings.flakesfile!=""){var j=new Image();j.onload=function(){c.flks_image=j;c.fi_width=c.flks_image.width;c.fi_height=c.flks_image.height;if((c.fi_width%c.fi_height)!=0){c.flks_image=null;c.fi_width=0;c.fi_height=0;a(this).smakflakes.settings.flakesfile="";c.last_flakesfile=a(this).smakflakes.settings.flakesfile;}else{h();c.last_flakesfile=a(this).smakflakes.settings.flakesfile;}};j.src=a(this).smakflakes.settings.flakesfile;}if(a(this).smakflakes.settings.flakesize>30){a(this).smakflakes.settings.flakesize=30;}if(a(this).smakflakes.settings.flakesize<1){a(this).smakflakes.settings.flakesize=1;}a(this).smakflakes.settings.flakesize=a(this).smakflakes.settings.flakesize+3;a(this).smakflakes.settings.flakesize+=2;var i=a("<canvas />",{id:"flkscnvs"});i.attr({width:c.w_width-2+"px",height:c.w_height-2+"px"});i.css({position:"fixed","z-index":99999,"pointer-events":"none"});c.canvas=i;c.context=a(c.canvas)[0].getContext("2d");c.field.prepend(c.canvas);a(this).smakflakes.settings.falspeed=a(this).smakflakes.settings.falspeed;if(a(this).smakflakes.settings.falspeed<1){a(this).smakflakes.settings.falspeed=1;}if(a(this).smakflakes.settings.falspeed>30){a(this).smakflakes.settings.falspeed=30;}a(this).smakflakes.settings.wind=a(this).smakflakes.settings.wind;if(a(this).smakflakes.settings.wind<-3){a(this).smakflakes.settings.wind=-3;}if(a(this).smakflakes.settings.wind>3){a(this).smakflakes.settings.wind=3;}var g=a("<div>",{id:"snow_switch"});g.html("*");g.css({"z-index":99999,position:"fixed",width:"auto",height:"auto","padding-top":"6px","padding-bottom":"0px","padding-left":"9px","padding-right":"9px"});switch(a(this).smakflakes.settings.onoffpos){case"top right":g.css({right:"5px",top:"5px",left:"auto",bottom:"auto"});g.show();break;case"top left":g.css({left:"5px",top:"5px",right:"auto",bottom:"auto"});g.show();break;case"bottom right":g.css({right:"5px",bottom:"5px",left:"auto",top:"auto"});g.show();break;case"bottom left":g.css({left:"5px",bottom:"5px",right:"auto",top:"auto"});g.show();break;case"none":g.hide();break;default:g.css({right:"5px",top:"5px",left:"auto",bottom:"auto"});g.show();break;}c.field.append(g);a(window).resize(function(){c.w_height=a(window).height();c.w_width=a(window).width();i.attr({width:c.w_width-2+"px",height:c.w_height-2+"px"});});a("#snow_switch").click(function(){if(c.issnow){c.issnow=false;a(this).addClass("snowoff");}else{c.issnow=true;a(this).removeClass("snowoff");}});function f(){c.colors_random=new Array("204, 45, 33","204, 172, 44","113, 204, 48","121, 204, 193","70, 95, 204","182, 84, 204","204, 204, 182","0, 164, 204","204, 12, 67");for(var o=0;o<a(this).smakflakes.settings.flakescount;o++){var p={scale:1,sizeXY:0,left:0,top:0,axisx_forfal:0,maxvectorX:0,vectorX:0,incX:0,speed:0,opacity:0,opacity_mode:0,tmp_opacity:0,color:"",shadowcolor:"",shadowopacity:0.1,shadowopacity_mode:0.1,tmp_shadowopacity:0.1,imgindex:0,imgangle:0,imgangle_spch:0,imgangle_vector:0,imgangle_max:0,live:false};var n=10,q=1;q=c.getRandomArbitary(0.2,1);p.opacity=q;p.sizeXY=n;if(c.getRandomInt(0,100)>=50){p.scale=(-1)*c.getRandomArbitary(0.01,0.4);}else{p.scale=c.getRandomArbitary(0,0.2);}p.opacity_mode=p.opacity;p.shadowopacity_mode=p.shadowopacity;var m="",l="";c.last_flaketype=a(this).smakflakes.settings.flaketype;switch(a(this).smakflakes.settings.flaketype){case"lighter":m="255, 255, 255";l=m;break;case"darker":m="255, 255, 255";l="0, 0, 0";p.shadowopacity_mode=p.shadowopacity+=0.3;if(p.shadowopacity_mode>1){p.shadowopacity_mode=1;}p.opacity_mode=p.opacity+0.3;if(p.opacity_mode>1){p.opacity_mode=1;}break;case"varicolored":m=c.colors_random[c.getRandomInt(0,c.colors_random.length-1)];l=m;break;case"colored":m=c.genereateRGBstring(a(this).smakflakes.settings.flakecolor);l=c.genereateRGBstring(a(this).smakflakes.settings.flakeshadow_color);p.shadowopacity_mode=p.shadowopacity+0.3;if(p.shadowopacity_mode>1){p.shadowopacity_mode=1;}break;deafult:m="255, 255, 255";l=m;break;}if(p.shadowopacity>1){p.shadowopacity=1;}p.tmp_shadowopacity=p.shadowopacity;p.tmp_opacity=p.opacity;p.color=m;p.shadowcolor=l;var k=c.getRandomInt(0,1000);if((k>=0)&&(k<=25)){p.live=false;}else{p.live=true;}p.maxvectorX=c.getRandomInt(25,50);p.speed=c.getRandomArbitary(0.5,4);p.axisx_forfal=c.getRandomInt(10,c.w_width-p.sizeXY-10);p.left=p.axisx_forfal;p.top=(-1)*c.getRandomInt(0,c.w_height);p.imgangle_max=c.getRandomInt(5,60);p.imgangle_spch=c.getRandomArbitary(0.5,5);p.imgangle_vector=(c.getRandomInt(0,100)>=50)?-1:1;c.flakes.push(p);}}f();function h(){if(c.flks_image!=null){var k=Math.floor(c.fi_width/c.fi_height)-1;a.each(c.flakes,function(m,l){l.imgindex=c.getRandomInt(0,k);});}}setInterval(function(){if(c.last_stopfall!=a(this).smakflakes.settings.stopfall){c.issnow=!a(this).smakflakes.settings.stopfall;c.last_stopfall=a(this).smakflakes.settings.stopfall;}c.context.clearRect(0,0,c.w_width,c.w_height);if((c.last_flakesfile!=a(this).smakflakes.settings.flakesfile)){if(a(this).smakflakes.settings.flakesfile==""){c.flks_image=null;c.fi_width=0;c.fi_height=0;c.last_flakesfile=a(this).smakflakes.settings.flakesfile;}else{var k=new Image();k.onload=function(){c.flks_image=k;c.fi_width=c.flks_image.width;c.fi_height=c.flks_image.height;if((c.fi_width%c.fi_height)!=0){c.flks_image=null;c.fi_width=0;c.fi_height=0;a(this).smakflakes.settings.flakesfile="";c.last_flakesfile=a(this).smakflakes.settings.flakesfile;}else{h();c.last_flakesfile=a(this).smakflakes.settings.flakesfile;}};k.src=a(this).smakflakes.settings.flakesfile;}}a.each(c.flakes,function(o,q){if(!(c.issnow)){if((q.tmp_opacity<=0)&&(q.tmp_shadowopacity<=0)){q.tmp_opacity=0;q.tmp_shadowopacity=0;return;}else{q.tmp_opacity-=0.05;q.tmp_shadowopacity-=0.02;if(q.tmp_opacity<0){q.tmp_opacity=0;}if(q.tmp_shadowopacity<0){q.tmp_shadowopacity=0;}}}else{if(q.tmp_opacity<q.opacity){q.tmp_opacity+=0.02;}else{q.tmp_opacity=q.opacity;}if(q.tmp_shadowopacity<q.shadowopacity){q.tmp_shadowopacity+=0.01;}else{q.tmp_shadowopacity=q.shadowopacity;}}if(!(q.live)){var l=c.getRandomInt(0,1000);if((l>=0)&&(l<=25)){if(a(this).smakflakes.settings.wind<0){q.axisx_forfal=c.getRandomInt(100+Math.abs(a(this).smakflakes.settings.wind)*25,c.w_width+200+Math.abs(a(this).smakflakes.settings.wind)*25);}else{if(a(this).smakflakes.settings.wind>0){q.axisx_forfal=c.getRandomInt((-1)*(Math.abs(a(this).smakflakes.settings.wind)*25+200),c.w_width-(100+Math.abs(a(this).smakflakes.settings.wind)*25));}else{q.axisx_forfal=c.getRandomInt(10,c.w_width-10);}}if(c.flks_image==null){q.top=(-2)*(q.scale+a(this).smakflakes.settings.flakesize);}else{q.top=(-2)*(c.fi_height);}q.left=q.axisx_forfal;q.live=true;q.vectorX=0;q.speed=c.getRandomArbitary(0.5,4);}}else{if(((c.flks_image==null)&&((parseInt(q.left)>=(-1)*(q.scale+a(this).smakflakes.settings.flakesize))&&(parseInt(q.left)<=(c.w_width))))||((c.flks_image!=null)&&((parseInt(q.left)>=(-1)*c.fi_height)&&(parseInt(q.left)<=(c.w_width))))){var m=0,r=0;if(!(c.issnow)){m=q.tmp_opacity;r=q.tmp_shadowopacity;}else{if(q.tmp_opacity<q.opacity){m=q.tmp_opacity;}else{m=q.opacity;}if(q.tmp_shadowopacity<q.shadowopacity){r=q.tmp_shadowopacity;}else{r=q.shadowopacity;}}if(c.flks_image==null){c.context.beginPath();c.context.shadowBlur=5;c.context.shadowOffsetX=0;c.context.shadowOffsetY=0;if(a(this).smakflakes.settings.randomsize==true){c.context.arc(q.left+Math.floor(q.sizeXY*(q.scale+(a(this).smakflakes.settings.flakesize/10))/2),q.top+Math.floor(q.sizeXY*(q.scale+(a(this).smakflakes.settings.flakesize/10))/2),q.sizeXY*(q.scale+(a(this).smakflakes.settings.flakesize/10))/2,0,2*Math.PI);}else{c.context.arc(q.left+Math.floor(q.sizeXY*(a(this).smakflakes.settings.flakesize/10)/2),q.top+Math.floor(q.sizeXY*(a(this).smakflakes.settings.flakesize/10)/2),q.sizeXY*(a(this).smakflakes.settings.flakesize/10)/2,0,2*Math.PI);}if(a(this).smakflakes.settings.flaketype!=c.last_flaketype){a.each(c.flakes,function(w,y){var v="",x="";switch(a(this).smakflakes.settings.flaketype){case"lighter":v="255, 255, 255";x=v;y.shadowopacity_mode=y.shadowopacity;y.opacity_mode=y.opacity;break;case"darker":v="255, 255, 255";x="0, 0, 0";y.shadowopacity_mode=y.shadowopacity+0.3;if(y.shadowopacity_mode>1){y.shadowopacity_mode=1;}y.opacity_mode=y.opacity+0.3;if(y.opacity_mode>1){y.opacity_mode=1;}break;case"varicolored":v=c.colors_random[c.getRandomInt(0,c.colors_random.length-1)];x=v;y.shadowopacity_mode=y.shadowopacity;y.opacity_mode=y.opacity;break;case"colored":y.shadowopacity_mode=y.shadowopacity+0.3;if(y.shadowopacity_mode>1){y.shadowopacity_mode=1;}y.opacity_mode=y.opacity;break;case"rainbow_shadow":y.opacity_mode=y.opacity+0.3;if(y.opacity_mode>1){y.opacity_mode=1;}break;deafult:v="255, 255, 255";x=v;y.shadowopacity_mode=y.shadowopacity;y.opacity_mode=y.opacity;break;}y.tmp_opacity=y.opacity_mode;y.tmp_shadowopacity=y.shadowopacity_mode;y.shadowcolor=x;y.color=v;});c.last_flaketype=a(this).smakflakes.settings.flaketype;}var t="",n="";if(a(this).smakflakes.settings.flaketype=="colored"){t=c.genereateRGBstring(a(this).smakflakes.settings.flakecolor);n=c.genereateRGBstring(a(this).smakflakes.settings.flakeshadow_color);}if((a(this).smakflakes.settings.flaketype=="rainbow_shadow")||(a(this).smakflakes.settings.flaketype=="rainbow")){var u="";switch(c.rainbowstep){case 0:if(Math.floor(c.rainbowclr)<255){c.rainbowclr+=0.1;}else{c.rainbowstep++;}u="255, 0, "+Math.floor(c.rainbowclr);break;case 1:if(Math.floor(c.rainbowclr)>0){c.rainbowclr-=0.1;}else{c.rainbowstep++;}u=Math.floor(c.rainbowclr)+", 0, 255";break;case 2:if(Math.floor(c.rainbowclr)<255){c.rainbowclr+=0.1;}else{c.rainbowstep++;}u="0, "+Math.floor(c.rainbowclr)+", 255";break;case 3:if(Math.floor(c.rainbowclr)>0){c.rainbowclr-=0.1;}else{c.rainbowstep++;}u="0, 255, "+Math.floor(c.rainbowclr);break;case 4:if(Math.floor(c.rainbowclr)<255){c.rainbowclr+=0.1;}else{c.rainbowstep++;}u=Math.floor(c.rainbowclr)+", 255, 0";break;case 5:if(Math.floor(c.rainbowclr)>0){c.rainbowclr-=0.1;}else{c.rainbowstep=0;}u="255, "+Math.floor(c.rainbowclr)+", 0";break;default:break;}if(a(this).smakflakes.settings.flaketype=="rainbow_shadow"){n=u;t="255, 255, 255";}else{n="50, 50, 50";t=u;}}if((a(this).smakflakes.settings.flaketype=="rainbow")||(a(this).smakflakes.settings.flaketype=="rainbow_shadow")||(a(this).smakflakes.settings.flaketype=="colored")){c.context.shadowColor="rgba("+n+","+r+")";c.context.fillStyle="rgba("+t+","+m+")";}else{c.context.shadowColor="rgba("+q.shadowcolor+","+r+")";c.context.fillStyle="rgba("+q.color+","+m+")";}c.context.fill();c.context.closePath();}else{c.context.save();c.context.globalAlpha=m;c.context.shadowColor="rgba(0,0,0,0)";c.context.translate(parseInt(q.left+c.fi_height/2),parseInt(q.top+c.fi_height/2));switch(a(this).smakflakes.settings.firotation){case"cw":if(q.imgangle>=360){q.imgangle=0;}q.imgangle+=c.getRandomInt(2,10);break;case"ccw":if(q.imgangle<=0){q.imgangle=360;}q.imgangle-=c.getRandomInt(2,10);break;case"toandfro":if(Math.abs(q.imgangle)>=q.imgangle_max){if(q.imgangle<0){q.imgangle_vector=1;}else{q.imgangle_vector=-1;}}q.imgangle+=q.imgangle_vector*q.imgangle_spch;break;case"none":q.imgangle=0;break;default:q.imgangle=0;break;}c.context.rotate(c.inRad(q.imgangle));c.context.drawImage(c.flks_image,parseInt(q.imgindex*c.fi_height),0,parseInt(c.fi_height),parseInt(c.fi_height),parseInt((-1)*(c.fi_height/2)),parseInt((-1)*(c.fi_height/2)),parseInt(c.fi_height),parseInt(c.fi_height));c.context.restore();}}q.axisx_forfal=q.axisx_forfal+a(this).smakflakes.settings.wind;var s=false;if(c.flks_image==null){s=((parseInt(q.top)>=parseInt(c.w_height))||((a(this).smakflakes.settings.wind<0)&&(parseInt(q.axisx_forfal+q.vectorX)<(-1)*Math.floor(q.sizeXY*(a(this).smakflakes.settings.flakesize/10))))||((a(this).smakflakes.settings.wind>0)&&(parseInt(q.axisx_forfal+q.vectorX)>=parseInt(c.w_width))));}else{s=((parseInt(q.top)>=parseInt(c.w_height))||((a(this).smakflakes.settings.wind<0)&&(parseInt(q.axisx_forfal+q.vectorX)<(-1)*parseInt(c.fi_height)))||((a(this).smakflakes.settings.wind>0)&&(parseInt(q.axisx_forfal+q.vectorX)>=parseInt(c.w_width))));}if(s){q.live=false;}else{q.top=parseInt(q.top)+(a(this).smakflakes.settings.falspeed+q.speed);q.left=q.axisx_forfal+q.vectorX;}var p=c.getRandomInt(0,100);if((p>=30)&&(p<=33)){q.incX=c.getRandomArbitary(-1,1);}q.vectorX+=q.incX;if(Math.abs(q.vectorX)>q.maxvectorX){if(q.vectorX<0){q.vectorX=(-1)*q.maxvectorX;}else{q.vectorX=q.maxvectorX;}q.incX=(-1)*q.incX;}}});},50);});},setflaketype:function(e){if(a(this).smakflakes.settings.flaketype==e){return;}switch(e){case"lighter":a(this).smakflakes.settings.flaketype="lighter";break;case"darker":a(this).smakflakes.settings.flaketype="darker";break;case"varicolored":a(this).smakflakes.settings.flaketype="varicolored";break;case"colored":a(this).smakflakes.settings.flaketype="colored";break;case"rainbow":a(this).smakflakes.settings.flaketype="rainbow";break;case"rainbow_shadow":a(this).smakflakes.settings.flaketype="rainbow_shadow";break;default:a(this).smakflakes.settings.flaketype="lighter";break;}return a(this).smakflakes.settings.flaketype;},setflakecolor:function(e){if(!c.compareRGBs(a(this).smakflakes.settings.flakecolor,e)){a(this).smakflakes.settings.flakecolor=e;}return a(this).smakflakes.settings.flakecolor;},setflakeshadow_color:function(e){if(!c.compareRGBs(a(this).smakflakes.settings.flakeshadow_color,e)){a(this).smakflakes.settings.flakeshadow_color=e;}return a(this).smakflakes.settings.flakeshadow_color;},setsize:function(e){if(e>30){a(this).smakflakes.settings.flakesize=30;}if(e<1){a(this).smakflakes.settings.flakesize=1;}a(this).smakflakes.settings.flakesize=e+3;return a(this).smakflakes.settings.flakesize;},setrandomsize:function(e){if(e){a(this).smakflakes.settings.randomsize=true;}else{a(this).smakflakes.settings.randomsize=false;}return a(this).smakflakes.settings.randomsize;},setswpos:function(f){var e=a(this).find("div#snow_switch");switch(f){case"top right":e.css({right:"5px",top:"5px",left:"auto",bottom:"auto"});e.show();a(this).smakflakes.settings.onoffpos=f;break;case"top left":e.css({left:"5px",top:"5px",right:"auto",bottom:"auto"});e.show();a(this).smakflakes.settings.onoffpos=f;break;case"bottom right":e.css({right:"5px",bottom:"5px",left:"auto",top:"auto"});e.show();a(this).smakflakes.settings.onoffpos=f;break;case"bottom left":e.css({left:"5px",bottom:"5px",right:"auto",top:"auto"});e.show();a(this).smakflakes.settings.onoffpos=f;break;case"none":a(this).smakflakes.settings.onoffpos=f;e.hide();break;default:e.css({right:"5px",top:"5px",left:"auto",bottom:"auto"});e.show();a(this).smakflakes.settings.onoffpos=f;break;}return a(this).smakflakes.settings.onoffpos;},setimgflakes:function(e){a(this).smakflakes.settings.flakesfile=e;return a(this).smakflakes.settings.flakesfile;},setimgrotation:function(e){switch(e){case"cw":case"ccw":case"toandfro":case"none":a(this).smakflakes.settings.firotation=e;break;default:a(this).smakflakes.settings.firotation="none";break;}return a(this).smakflakes.settings.firotation;},setwind:function(e){a(this).smakflakes.settings.wind=e;if(typeof(e)=="number"){if(e<-5){a(this).smakflakes.settings.wind=-5;}if(e>5){a(this).smakflakes.settings.wind=5;}}else{if(typeof(e)=="string"){switch(e){case"random":case"timechange":break;default:a(this).smakflakes.settings.wind=e;break;}}}return a(this).smakflakes.settings.wind;},setfalspeed:function(e){a(this).smakflakes.settings.falspeed=e;if(e<1){a(this).smakflakes.settings.falspeed=1;}if(e>30){a(this).smakflakes.settings.falspeed=30;}return a(this).smakflakes.settings.falspeed;},stopFalling:function(){a(this).smakflakes.settings.stopfall=true;return a(this).smakflakes.settings.stopfall;},startFalling:function(){a(this).smakflakes.settings.stopfall=false;return a(this).smakflakes.settings.stopfall;}};if(b[d]){return b[d].apply(this,Array.prototype.slice.call(arguments,1));}else{if(typeof d==="object"||!d){return b.init.apply(this,arguments);}else{a.error('Method "'+d+'" does not exist in smakflakes plugin!');}}};a.fn.smakflakes.defaults={stopfall:false,onoffpos:"top right",flakescount:60,flakesize:1,randomsize:true,flaketype:"darker",flakecolor:{r:255,g:255,b:255},flakeshadow_color:{r:0,g:0,b:0},falspeed:1,wind:0,flakesfile:"",firotation:"toandfro"};a.fn.smakflakes.settings={};})(jQuery);